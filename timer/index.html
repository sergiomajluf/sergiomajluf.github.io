"use client"

import { useState, useEffect, useRef } from "react"
import { Play, Pause, SkipForward, RotateCcw, Settings, X } from "lucide-react"

interface Phase {
  name: string
  totalSeconds: number
  secondsRemaining: number
  warningPoint: number
}

interface Phases {
  presentation: Phase
  questions: Phase
}

type PhaseType = "presentation" | "questions"
type DisplayClass = "normal" | "warning" | "overtime"

export default function PresentationTimer() {
  const [isRunning, setIsRunning] = useState(false)
  const [currentPhase, setCurrentPhase] = useState<PhaseType>("presentation")
  const [showSettings, setShowSettings] = useState(false)
  const [backgroundAlerts, setBackgroundAlerts] = useState(false)

  // Configuración inicial
  const [presentationMinutes, setPresentationMinutes] = useState(3)
  const [presentationWarning, setPresentationWarning] = useState(1)
  const [questionsMinutes, setQuestionsMinutes] = useState(3)
  const [questionsWarning, setQuestionsWarning] = useState(1)

  const [phases, setPhases] = useState<Phases>({
    presentation: {
      name: "Presentación",
      totalSeconds: 180,
      secondsRemaining: 180,
      warningPoint: 60,
    },
    questions: {
      name: "Preguntas",
      totalSeconds: 180,
      secondsRemaining: 180,
      warningPoint: 60,
    },
  })

  const timerInterval = useRef<NodeJS.Timeout | null>(null)

  // Inicializar temporizador
  const initTimer = () => {
    const presentationSeconds = presentationMinutes * 60
    const presentationWarningSeconds = presentationWarning * 60
    const questionsSeconds = questionsMinutes * 60
    const questionsWarningSeconds = questionsWarning * 60

    setPhases({
      presentation: {
        name: "Presentación",
        totalSeconds: presentationSeconds,
        secondsRemaining: presentationSeconds,
        warningPoint: presentationWarningSeconds,
      },
      questions: {
        name: "Preguntas",
        totalSeconds: questionsSeconds,
        secondsRemaining: questionsSeconds,
        warningPoint: questionsWarningSeconds,
      },
    })

    setCurrentPhase("presentation")
  }

  // Formatear tiempo
  const formatTime = (seconds: number): string => {
    const isNegative = seconds < 0
    const absSeconds = Math.abs(seconds)
    const minutes = Math.floor(absSeconds / 60)
    const secs = absSeconds % 60

    const sign = isNegative ? "-" : ""
    return sign + String(minutes).padStart(2, "0") + ":" + String(secs).padStart(2, "0")
  }

  // Determinar clase de visualización
  const getDisplayClass = (seconds: number, warningPoint: number): DisplayClass => {
    if (seconds < 0) {
      return "overtime"
    } else if (seconds <= warningPoint && warningPoint > 0) {
      return "warning"
    } else {
      return "normal"
    }
  }

  // Obtener tiempo total restante
  const getTotalRemainingSeconds = (): number => {
    return phases.presentation.secondsRemaining + phases.questions.secondsRemaining
  }

  // Determinar el estado del fondo
  const getBackgroundState = (): DisplayClass => {
    const totalRemainingSeconds = getTotalRemainingSeconds()
    const currentPhaseData = phases[currentPhase]

    if (totalRemainingSeconds < 0) {
      return "overtime"
    } else if (
      currentPhaseData.secondsRemaining <= currentPhaseData.warningPoint &&
      currentPhaseData.warningPoint > 0
    ) {
      return "warning"
    } else {
      return "normal"
    }
  }

  // Iniciar temporizador
  const startTimer = () => {
    if (isRunning) return

    setIsRunning(true)
    timerInterval.current = setInterval(() => {
      setPhases((prevPhases) => {
        const newPhases = { ...prevPhases }
        newPhases[currentPhase].secondsRemaining--

        // Si estamos en presentación y llegamos a -1, pasar a preguntas
        if (
          currentPhase === "presentation" &&
          newPhases.presentation.secondsRemaining === -1 &&
          newPhases.questions.totalSeconds > 0
        ) {
          setCurrentPhase("questions")
        }

        return newPhases
      })
    }, 1000)
  }

  // Pausar temporizador
  const pauseTimer = () => {
    if (!isRunning) return

    setIsRunning(false)
    if (timerInterval.current) {
      clearInterval(timerInterval.current)
    }
  }

  // Reiniciar temporizador
  const resetTimer = () => {
    pauseTimer()
    initTimer()
  }

  // Siguiente fase
  const nextPhase = () => {
    if (currentPhase === "presentation") {
      setCurrentPhase("questions")
    }
  }

  // Efecto para aplicar el fondo cuando backgroundAlerts está habilitado
  useEffect(() => {
    if (backgroundAlerts) {
      const backgroundState = getBackgroundState()
      const body = document.body

      // Remover clases anteriores
      body.classList.remove("bg-warning", "bg-overtime", "bg-normal")

      // Añadir clase correspondiente
      body.classList.add(`bg-${backgroundState}`)
    } else {
      // Remover todas las clases de fondo si está deshabilitado
      document.body.classList.remove("bg-warning", "bg-overtime", "bg-normal")
    }

    // Cleanup al desmontar
    return () => {
      document.body.classList.remove("bg-warning", "bg-overtime", "bg-normal")
    }
  }, [backgroundAlerts, phases, currentPhase])

  // Inicializar al montar
  useEffect(() => {
    initTimer()
    // Mostrar configuración inicialmente en desktop
    if (window.innerWidth > 768) {
      setShowSettings(true)
    }
  }, [])

  // Reinicializar cuando cambien las configuraciones
  useEffect(() => {
    if (!isRunning) {
      initTimer()
    }
  }, [presentationMinutes, presentationWarning, questionsMinutes, questionsWarning])

  const totalRemainingSeconds = getTotalRemainingSeconds()
  const backgroundState = getBackgroundState()

  return (
    <>
      <style jsx global>{`
        :root {
          --apple-bg: #f5f5f7;
          --apple-card: #ffffff;
          --apple-text: #1d1d1f;
          --apple-text-secondary: #86868b;
          --apple-blue: #0071e3;
          --apple-red: #ff3b30;
          --apple-gray: #8e8e93;
          --apple-warning: #ff9500;
          --apple-overtime: #ff3b30;
          --apple-shadow: rgba(0, 0, 0, 0.1);
        }
        
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Helvetica Neue', Helvetica, Arial, sans-serif;
          background-color: var(--apple-bg);
          color: var(--apple-text);
          line-height: 1.5;
          transition: background-color 0.3s ease;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
        
        body.bg-warning {
          background-color: var(--apple-warning);
        }
        
        body.bg-overtime {
          background-color: var(--apple-overtime);
        }
        
        body.bg-normal {
          background-color: var(--apple-bg);
        }
        
        .container {
          background-color: var(--apple-card);
          border-radius: 20px;
          box-shadow: 0 4px 24px var(--apple-shadow);
          padding: 32px;
          width: 90%;
          max-width: 750px;
          margin: 20px auto;
        }
        
        .total-timer-container {
          display: inline-block;
          border-radius: 20px;
          padding: 4px 20px;
          transition: all 0.3s ease;
        }
        
        .total-timer-display {
          font-size: 120px;
          font-weight: 300;
          border-radius: 16px;
          padding: 8px;
          transition: all 0.3s ease;
        }
        
        .phase-timer-display {
          font-size: 56px;
          font-weight: 300;
          transition: all 0.3s ease;
          border-radius: 10px;
          padding: 4px 8px;
        }
        
        .normal {
          color: var(--apple-text);
        }
        
        .warning {
          color: var(--apple-text);
          background-color: var(--apple-warning);
          animation: pulse 1.5s infinite;
        }
        
        .overtime {
          color: white;
          background-color: var(--apple-overtime);
        }
        
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.02); }
          100% { transform: scale(1); }
        }
        
        @media (max-width: 768px) {
          .container {
            padding: 20px;
            width: 95%;
            margin: 10px auto;
          }
          
          .total-timer-display {
            font-size: 80px;
          }
          
          .phase-timer-display {
            font-size: 48px;
          }
        }
        
        @media (max-width: 480px) {
          .total-timer-display {
            font-size: 64px;
          }
          
          .phase-timer-display {
            font-size: 48px;
          }
        }
      `}</style>

      <div className="min-h-screen flex items-center justify-center p-4">
        <div className="container">
          <h1 className="text-center font-semibold text-3xl mb-6 text-gray-900">Temporizador para Presentaciones</h1>

          {/* Total Timer Display */}
          <div className="text-center mb-8">
            <div className="text-gray-500 mb-2 text-lg font-medium">Tiempo Total Restante</div>
            <div
              className="total-timer-container"
              style={{
                backgroundColor:
                  backgroundState === "overtime"
                    ? "var(--apple-overtime)"
                    : backgroundState === "warning"
                      ? "var(--apple-warning)"
                      : "transparent",
              }}
            >
              <div className={`total-timer-display ${backgroundState}`}>{formatTime(totalRemainingSeconds)}</div>
            </div>
          </div>

          {/* Phase Timers Display */}
          <div className="flex justify-between gap-5 mb-10 max-md:flex-col max-md:gap-4">
            <div
              className={`flex-1 text-center bg-gray-50 rounded-2xl p-5 transition-all duration-300 ${
                phases.questions.totalSeconds === 0 ? "opacity-50" : ""
              }`}
            >
              <div className="text-lg font-medium text-gray-900 mb-3">Tiempo de Presentación</div>
              <div
                className={`phase-timer-display ${getDisplayClass(phases.presentation.secondsRemaining, phases.presentation.warningPoint)}`}
              >
                {formatTime(phases.presentation.secondsRemaining)}
              </div>
            </div>

            <div
              className={`flex-1 text-center bg-gray-50 rounded-2xl p-5 transition-all duration-300 ${
                phases.questions.totalSeconds === 0 ? "opacity-50" : ""
              }`}
            >
              <div className="text-lg font-medium text-gray-900 mb-3">Tiempo de Preguntas</div>
              <div
                className={`phase-timer-display ${getDisplayClass(phases.questions.secondsRemaining, phases.questions.warningPoint)}`}
              >
                {formatTime(phases.questions.secondsRemaining)}
              </div>
            </div>
          </div>

          {/* Settings Toggle Button */}
          <div className="flex justify-center mb-4">
            <button
              onClick={() => setShowSettings(!showSettings)}
              className="flex items-center gap-2 bg-transparent text-gray-500 border border-gray-400 rounded-2xl px-4 py-2 text-sm cursor-pointer transition-all duration-200 hover:bg-gray-50"
            >
              {showSettings ? <X size={16} /> : <Settings size={16} />}
              {showSettings ? "Ocultar configuración" : "Mostrar configuración"}
            </button>
          </div>

          {/* Settings Section */}
          {showSettings && (
            <div
              className="bg-gray-50 rounded-2xl p-6 mb-6 transition-all duration-300"
              style={{
                opacity: isRunning ? 0.5 : 1,
              }}
            >
              <h2 className="text-center text-xl font-medium mb-6 text-gray-900">Configuración de Tiempos</h2>

              <div className="grid grid-cols-3 gap-4 mb-3 font-medium text-gray-500 text-sm">
                <div>Fase</div>
                <div>Duración (min)</div>
                <div>Alerta (min)</div>
              </div>

              <div className="grid grid-cols-3 gap-4 mb-4 items-center">
                <div>Presentación</div>
                <div>
                  <input
                    type="number"
                    min="1"
                    max="60"
                    value={presentationMinutes}
                    onChange={(e) => setPresentationMinutes(Number.parseInt(e.target.value) || 1)}
                    disabled={isRunning}
                    className="w-full p-3 border-none rounded-lg text-lg bg-white shadow-sm text-gray-900 text-center focus:outline-none focus:ring-3 focus:ring-blue-200 disabled:bg-gray-100 disabled:text-gray-400"
                  />
                </div>
                <div>
                  <input
                    type="number"
                    min="0"
                    max="60"
                    value={presentationWarning}
                    onChange={(e) => setPresentationWarning(Number.parseInt(e.target.value) || 0)}
                    disabled={isRunning}
                    className="w-full p-3 border-none rounded-lg text-lg bg-white shadow-sm text-gray-900 text-center focus:outline-none focus:ring-3 focus:ring-blue-200 disabled:bg-gray-100 disabled:text-gray-400"
                  />
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4 mb-6 items-center">
                <div>Preguntas</div>
                <div>
                  <input
                    type="number"
                    min="0"
                    max="60"
                    value={questionsMinutes}
                    onChange={(e) => setQuestionsMinutes(Number.parseInt(e.target.value) || 0)}
                    disabled={isRunning}
                    className="w-full p-3 border-none rounded-lg text-lg bg-white shadow-sm text-gray-900 text-center focus:outline-none focus:ring-3 focus:ring-blue-200 disabled:bg-gray-100 disabled:text-gray-400"
                  />
                </div>
                <div>
                  <input
                    type="number"
                    min="0"
                    max="60"
                    value={questionsWarning}
                    onChange={(e) => setQuestionsWarning(Number.parseInt(e.target.value) || 0)}
                    disabled={isRunning}
                    className="w-full p-3 border-none rounded-lg text-lg bg-white shadow-sm text-gray-900 text-center focus:outline-none focus:ring-3 focus:ring-blue-200 disabled:bg-gray-100 disabled:text-gray-400"
                  />
                </div>
              </div>

              {/* Background Alerts Option */}
              <div className="border-t border-gray-200 pt-4">
                <label className="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={backgroundAlerts}
                    onChange={(e) => setBackgroundAlerts(e.target.checked)}
                    className="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                  />
                  <span className="text-gray-900 font-medium">Cambiar color de fondo de la página durante alertas</span>
                </label>
                <p className="text-sm text-gray-500 mt-1 ml-8">
                  Cuando esté habilitado, el fondo de toda la página cambiará a naranja (alerta) o rojo (tiempo agotado)
                </p>
              </div>
            </div>
          )}

          {/* Controls */}
          <div className="flex justify-between gap-3 max-md:flex-wrap">
            <button
              onClick={startTimer}
              disabled={isRunning}
              className="flex-1 flex items-center justify-center gap-2 p-4 border-none rounded-lg text-lg font-medium cursor-pointer transition-all duration-200 bg-blue-600 text-white hover:bg-blue-700 hover:-translate-y-0.5 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed disabled:transform-none active:translate-y-0.5 max-md:min-w-[120px]"
            >
              <Play size={20} />
              Iniciar
            </button>

            <button
              onClick={pauseTimer}
              disabled={!isRunning}
              className="flex-1 flex items-center justify-center gap-2 p-4 border-none rounded-lg text-lg font-medium cursor-pointer transition-all duration-200 bg-gray-600 text-white hover:bg-gray-700 hover:-translate-y-0.5 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed disabled:transform-none active:translate-y-0.5 max-md:min-w-[120px]"
            >
              <Pause size={20} />
              Pausar
            </button>

            <button
              onClick={nextPhase}
              disabled={!isRunning}
              className="flex-1 flex items-center justify-center gap-2 p-4 border-none rounded-lg text-lg font-medium cursor-pointer transition-all duration-200 bg-gray-600 text-white hover:bg-gray-700 hover:-translate-y-0.5 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed disabled:transform-none active:translate-y-0.5 max-md:min-w-[120px]"
            >
              <SkipForward size={20} />
              Siguiente
            </button>

            <button
              onClick={resetTimer}
              className="flex-1 flex items-center justify-center gap-2 p-4 border-none rounded-lg text-lg font-medium cursor-pointer transition-all duration-200 bg-red-600 text-white hover:bg-red-700 hover:-translate-y-0.5 active:translate-y-0.5 max-md:min-w-[120px]"
            >
              <RotateCcw size={20} />
              Reiniciar
            </button>
          </div>
        </div>
      </div>
    </>
  )
}
